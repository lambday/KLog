# Makefile for LaTeX and HTML documentation

# Copyright (C) 2013-  Fabrizio Costa, Kurt De Grave, Luc De Raedt, Paolo Frasconi

# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.

# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

# The documentation is generated by pldoc and requires swi-prolog.
# kLog itself is incompatible with swi-prolog and several error
# messages are thus generated. They can be safely ignored: the only
# purpose of running swi-prolog on the kLog sources is to obtain
# documentation automatically.

.PHONY: clean

.SUFFIXES: .pl .tex .pdf 

SWIPL = /opt/local/bin/swipl

#STR=`(cd .. && pwd | sed -e"s/\//\\\//g")`
#STR=`(cd .. && pwd | sed -e "s/\//\\\\\\\\\//g")`
STR = $(shell (cd .. && pwd | sed -e 's/\//\\\//g') )

GENFILES.tex = doc/syntax.tex\
	doc/db.tex\
	doc/graphicalize.tex\
	doc/learn.tex\
	doc/kfold.tex\
	doc/repair.tex\
	doc/flags.tex\
	doc/timing.tex\
	doc/goals.tex\
	doc/utils.tex\
	doc/cinterface.tex
# do:
# 	echo ${STR}

# d1:
# 	cp graphicalize.tex f.tex
# 	sed -i '' -e's/${STR}//g' f.tex

all: klogdoc.pdf

doc/cinterface.pl: C/c_interface.cpp
	python doc/ccomm.py C/c_interface.cpp > doc/cinterface.pl
#	perl doc/ccomm.perl C/c_interface.cpp > doc/cinterface.pl
#	grep "^//" $< | sed -e 's/\/\//%/g' > $@
doc/cinterface.tex: doc/cinterface.pl
	$(SWIPL) -q -f doc/doc.pl -g "do_latex('$<','$@'),halt" -t "halt(1)"

C/doc_cinterface.pl: C/c_interface.cpp
	python doc/ccomm.py C/c_interface.cpp > C/doc_cinterface.pl

doc/%.tex: %.pl
	$(SWIPL) -q -f doc/doc.pl -g "do_latex('$<','$@'),halt" -t "halt(1)"
#	sed -i '' -e's/${STR}//g' $*.tex

%.pdf: %.tex
	pdflatex $*.tex

klogdoc.pdf: ${GENFILES.tex} doc/klogdoc.tex doc/pldoc.sty doc/cinterface.tex
#	$(SWIPL) -f doc.pl -g "run,halt" -t "halt(1)"
	cd doc && pdflatex klogdoc

html: syntax.pl db.pl graphicalize.pl flags.pl timing.pl repair.pl kfold.pl C/doc_cinterface.pl
	swipl -q -f make_html_doc.pl -t "halt(1)"
	echo "Ignore the many errors above"

clean:
	rm -f ${GENFILES.tex} doc/klogdoc.pdf doc/*.aux doc/*.idx doc/*.log doc/*.out
